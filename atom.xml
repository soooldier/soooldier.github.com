<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>烂笔头</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://soooldier.com/"/>
  <updated>2017-02-10T13:48:58.000Z</updated>
  <id>http://soooldier.com/</id>
  
  <author>
    <name>soooldier</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>nginx错误502，503，504分析</title>
    <link href="http://soooldier.com/2017/02/10/nginx%E9%94%99%E8%AF%AF502%EF%BC%8C503%EF%BC%8C504%E5%88%86%E6%9E%90/"/>
    <id>http://soooldier.com/2017/02/10/nginx错误502，503，504分析/</id>
    <published>2017-02-10T09:28:10.000Z</published>
    <updated>2017-02-10T13:48:58.000Z</updated>
    
    <content type="html">&lt;p&gt;开发过程中我们经常会遇到nginx 502，503，504错误，这些错误代表什么？什么情况下会出现这些错？下面一一说明（均以nignx+php-fpm举例）：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#5xx_Server_Error&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;wikipedia&lt;/a&gt;上这么解释：&lt;br&gt;&lt;strong&gt;502 Bad Gateway&lt;/strong&gt;&lt;br&gt;      The server was acting as a gateway or proxy and received an invalid response from the upstream server.&lt;br&gt;&lt;strong&gt;503 Service Unavailable&lt;/strong&gt;&lt;br&gt;      The server is currently unavailable (because it is overloaded or down for maintenance). Generally, this is a temporary state.&lt;br&gt;&lt;strong&gt;504 Gateway Time-out&lt;/strong&gt;&lt;br&gt;      The server was acting as a gateway or proxy and did not receive a timely response from the upstream server.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;502-Bad-Gateway&quot;&gt;&lt;a href=&quot;#502-Bad-Gateway&quot; class=&quot;headerlink&quot; title=&quot;502 Bad Gateway&quot;&gt;&lt;/a&gt;502 Bad Gateway&lt;/h4&gt;&lt;p&gt;fpm进程挂掉或者后端程序过长时间未返回。&lt;br&gt;编写一个简单的php脚本&lt;code&gt;gateway.php&lt;/code&gt;进行测试，内容很简单&lt;code&gt;&amp;lt;?php sleep(10);echo &amp;#39;ok;&amp;#39;?&amp;gt;&lt;/code&gt;，开始下面的测试：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;启动nginx，不启动fpm，直接&lt;code&gt;curl http://localhost/gateway.php&lt;/code&gt;，响应502 bad gateway错误且nginx的error log出现错误&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;2017/02/10 19:08:21 [error] 216#216: *84 connect() failed (111: Connection refused) while connecting to upstream, client: 172.17.0.1, server: website80.com, request: &amp;quot;GET /gateway.php HTTP/1.1&amp;quot;, upstream: &amp;quot;fastcgi://127.0.0.1:9000&amp;quot;, host: &amp;quot;localhost&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;启动fpm，修改php-fpm.conf中request_terminate_timeout的值为5s。继续&lt;code&gt;curl http://localhost/gateway.php&lt;/code&gt;，响应502 bad gateway。nginx error log报错&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;2017/02/10 19:10:57 [error] 246#246: *88 recv() failed (104: Connection reset by peer) while reading response header from upstream, client: 172.17.0.1, server: website80.com, request: &amp;quot;GET /gateway.php HTTP/1.1&amp;quot;, upstream: &amp;quot;fastcgi://127.0.0.1:9000&amp;quot;, host: &amp;quot;localhost&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;同时php-fpm报错&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[10-Feb-2017 19:10:57] WARNING: [pool www] child 242, script &amp;apos;/home/website/default/gateway.php&amp;apos; (request: &amp;quot;GET /gateway.php&amp;quot;) execution timed out (6.205572 sec), terminating&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[10-Feb-2017 19:10:57] WARNING: [pool www] child 242 exited on signal 15 (SIGTERM) after 36.692467 seconds from start&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;503-Service-Unavailable&quot;&gt;&lt;a href=&quot;#503-Service-Unavailable&quot; class=&quot;headerlink&quot; title=&quot;503 Service Unavailable&quot;&gt;&lt;/a&gt;503 Service Unavailable&lt;/h4&gt;</content>
    
    <summary type="html">
    
      &lt;p&gt;开发过程中我们经常会遇到nginx 502，503，504错误，这些错误代表什么？什么情况下会出现这些错？下面一一说明（均以nignx+php-fpm举例）：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#5xx_Server_Error&quot;&gt;wikipedia&lt;/a&gt;上这么解释：&lt;br&gt;&lt;strong&gt;502 Bad Gateway&lt;/strong&gt;&lt;br&gt;      The server was acting as a gateway or proxy and received an invalid response from the upstream server.&lt;br&gt;&lt;strong&gt;503 Service Unavailable&lt;/strong&gt;&lt;br&gt;      The server is currently unavailable (because it is overloaded or down for maintenance). Generally, this is a temporary state.&lt;br&gt;&lt;strong&gt;504 Gateway Time-out&lt;/strong&gt;&lt;br&gt;      The server was acting as a gateway or proxy and did not receive a timely response from the upstream server.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="lnmp" scheme="http://soooldier.com/tags/lnmp/"/>
    
  </entry>
  
  <entry>
    <title>记一次lnmp环境问题</title>
    <link href="http://soooldier.com/2016/09/08/%E8%AE%B0%E4%B8%80%E6%AC%A1lnmp%E7%8E%AF%E5%A2%83%E9%97%AE%E9%A2%98/"/>
    <id>http://soooldier.com/2016/09/08/记一次lnmp环境问题/</id>
    <published>2016-09-08T12:53:32.000Z</published>
    <updated>2016-09-09T03:02:25.000Z</updated>
    
    <content type="html">&lt;h4 id=&quot;起因&quot;&gt;&lt;a href=&quot;#起因&quot; class=&quot;headerlink&quot; title=&quot;起因&quot;&gt;&lt;/a&gt;起因&lt;/h4&gt;&lt;p&gt;本打算把公司内部的php升级为5.6.x，op給了一个测试环境。于是便开始了环境搭建并测试的工作，configure，make，make install。正当我使用phpinfo()测试通过天真地以为环境搭建完成的时候，突然发现了一个奇怪的问题：通过fpm访问php的错误日志并未纪录在php.ini指定的日志文件中而却出现在了php-fpm.conf指定的配置文件。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;问题复现&quot;&gt;&lt;a href=&quot;#问题复现&quot; class=&quot;headerlink&quot; title=&quot;问题复现&quot;&gt;&lt;/a&gt;问题复现&lt;/h4&gt;&lt;p&gt;php.ini中跟错误记录相关的配置如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;error_reporting = E_ALL&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log_errors = On&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error_log = /home/ziroom/runtime/php/var/log/php-errors.log&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;php-fpm.conf的配置：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;error_log = /home/ziroom/runtime/php/var/log/php-fpm.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log_level = notice&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;; Redirect worker stdout and stderr into main error log. If not set, stdout and stderr will be redirected to /dev/null according to FastCGI specs. Note: on highloaded environement, this can cause some delay in the page process time (several ms).&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;catch_workers_output = yes&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意fpm中的catch_workers_output设置，它的作用是把fpm worker进程的stdout和stderr转发到主进程的error log。&lt;strong&gt;一定设置它为yes！！！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;访问测试脚本test.php，它的内容为&lt;code&gt;echo 2/0;&lt;/code&gt;，php-fpm.log中的日志内容如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[08-Sep-2016 14:29:41] WARNING: [pool www] child 126 said into stderr: &amp;quot;NOTICE: PHP message: PHP Warning:  Division by zero in /usr/local/nginx/html/index.php on line 2&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;问题排查&quot;&gt;&lt;a href=&quot;#问题排查&quot; class=&quot;headerlink&quot; title=&quot;问题排查&quot;&gt;&lt;/a&gt;问题排查&lt;/h4&gt;&lt;p&gt;从上面的日志可以看出pid为126的进程（fpm子进程）向stderr发送了一条级别为NOTICE的错误信息，这条错误信息恰好是php抛出的一个Warning；但是对于真正记录错误日志的fpm主进程来说却又是一个WARNING。&lt;/p&gt;
&lt;p&gt;接下来试着调高fpm的log_level为warning，重新访问test.php。结果并没有记录任何错误日志。这个现象很容易解释，fpm子进程向stderr传递的是一个NOTICE级别的信息，而配置文件中log_level的设置高于NOTICE，因而不会记录日志。&lt;/p&gt;
&lt;p&gt;但是！！！为何php的错误会记录到fpm的日志文件中？请叫老b得知他没有这个问题，那么一定我自己的问题了。几经辗转后超哥提醒我：&lt;strong&gt;看看是不是权限的问题！&lt;/strong&gt; 刚开始其实我是拒绝的，因为按常理来说如果是因为权限问题的话在日志文件里应该会有报错的。苦于没有别的办法就看了下目录权限，卧槽！！！真是有问题，fpm的用户和组都是ziroom，而配置的&lt;code&gt;/home/ziroom/runtime/php/var/log/php-errors.log&lt;/code&gt;对ziroom用户来说却没有写入权限。修改权限后重启fpm，访问test.php，一切正常，错误日志写到了php-errors.log中。&lt;/p&gt;
&lt;h4 id=&quot;追根溯源&quot;&gt;&lt;a href=&quot;#追根溯源&quot; class=&quot;headerlink&quot; title=&quot;追根溯源&quot;&gt;&lt;/a&gt;追根溯源&lt;/h4&gt;&lt;p&gt;问题虽然解决了，但是并未解决掉心里的疑问，打算再追查下去。疑问有2 ：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;没有权限为什么没有报错&lt;/li&gt;
&lt;li&gt;写入php-errors.log没有权限，为何写入php-fpm.log却有权限&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;对于问题1，root用户启动php-fpm主进程，主进程fork子进程，它的用户被设置成了fpm。于是把fpm的子进程数量改为1，strace该进程看到以下信息：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;docker环境直接使用strace会报错（strace: attach: ptrace(PTRACE_ATTACH, …): Operation not permitted）必须打开选项–privileged&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;open(&amp;quot;/usr/local/nginx/html/index.php&amp;quot;, O_RDONLY) = 5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fstat(5, &amp;#123;st_mode=S_IFREG|0644, st_size=16, ...&amp;#125;) = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fstat(5, &amp;#123;st_mode=S_IFREG|0644, st_size=16, ...&amp;#125;) = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fstat(5, &amp;#123;st_mode=S_IFREG|0644, st_size=16, ...&amp;#125;) = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mmap(NULL, 16, PROT_READ, MAP_SHARED, 5, 0) = 0x7f8aa96dd000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;getcwd(&amp;quot;/&amp;quot;, 4095)                       = 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chdir(&amp;quot;/usr/local/nginx/html&amp;quot;)          = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setitimer(ITIMER_PROF, &amp;#123;it_interval=&amp;#123;0, 0&amp;#125;, it_value=&amp;#123;30, 0&amp;#125;&amp;#125;, NULL) = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;munmap(0x7f8aa96dd000, 16)              = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;close(5)                                = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;open(&amp;quot;/usr/local/php/var/log/php_errors.log&amp;quot;, O_WRONLY|O_CREAT|O_APPEND, 0644) = -1 EACCES (Permission denied)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;write(2, &amp;quot;NOTICE: PHP message: PHP Warning&amp;quot;..., 97) = 97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chdir(&amp;quot;/&amp;quot;)                              = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;times(&amp;#123;tms_utime=0, tms_stime=0, tms_cutime=0, tms_cstime=0&amp;#125;) = 4296910449&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;stat(&amp;quot;/etc/localtime&amp;quot;, &amp;#123;st_mode=S_IFREG|0644, st_size=118, ...&amp;#125;) = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;write(4, &amp;quot;127.0.0.1 -  09/Sep/2016:01:59:5&amp;quot;..., 110) = 110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setitimer(ITIMER_PROF, &amp;#123;it_interval=&amp;#123;0, 0&amp;#125;, it_value=&amp;#123;0, 0&amp;#125;&amp;#125;, NULL) = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;write(3, &amp;quot;\1\7\0\1\0Y\7\0PHP message: PHP Warning&amp;quot;..., 200) = 200&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;shutdown(3, SHUT_WR)                    = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;recvfrom(3, &amp;quot;\1\5\0\1\0\0\0\0&amp;quot;, 8, 0, NULL, NULL) = 8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;recvfrom(3, &amp;quot;&amp;quot;, 8, 0, NULL, NULL)       = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;close(3)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以看到通过strace拿到的信息中出现了&lt;em&gt;Permission denied&lt;/em&gt;关键字，紧接着把”NOTICE: PHP message: PHP Warning”字符串写到了标准错误输出。这就和第一次在php-fpm日志中看到的信息相符了。&lt;/p&gt;
&lt;p&gt;问题2，fpm主进程是以root用户启动的，那么大胆猜测一下php-fpm.log只有fpm主进程才往日志里添加内容。lsof看一下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ lsof /usr/local/php/var/log/php-fpm.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ php-fpm 125 root    2w   REG   0,46     1967  607 /usr/local/php/var/log/php-fpm.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ php-fpm 125 root    3w   REG   0,46     1967  607 /usr/local/php/var/log/php-fpm.log&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;果不其然，只有fpm的主进程（pid为125）才向php-fpm.log文件中写入日志。&lt;/p&gt;
&lt;h4 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h4&gt;&lt;p&gt;至此，忽略内部更详尽细节，已经完全解决了文章开头的疑问。至于fpm为何这么设计，我等菜鸟无法评论。&lt;/p&gt;
&lt;p&gt;最后感谢老b同志亲临现场指导，虽是由一个低级错误引起，但只需要稍微往深一点研究还是挺有意思的。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;起因&quot;&gt;&lt;a href=&quot;#起因&quot; class=&quot;headerlink&quot; title=&quot;起因&quot;&gt;&lt;/a&gt;起因&lt;/h4&gt;&lt;p&gt;本打算把公司内部的php升级为5.6.x，op給了一个测试环境。于是便开始了环境搭建并测试的工作，configure，make，make install。正当我使用phpinfo()测试通过天真地以为环境搭建完成的时候，突然发现了一个奇怪的问题：通过fpm访问php的错误日志并未纪录在php.ini指定的日志文件中而却出现在了php-fpm.conf指定的配置文件。&lt;/p&gt;
    
    </summary>
    
    
      <category term="lnmp" scheme="http://soooldier.com/tags/lnmp/"/>
    
  </entry>
  
</feed>
